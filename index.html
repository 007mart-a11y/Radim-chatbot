<!doctype html>
<html lang="cs">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Asistent obce Radim</title>

<style>
:root{
  --text:#0f172a;
  --muted:#475569;

  /* Brand (Radim) */
  --brand:#1e3a8a;
  --brand2:#1d4ed8;

  /* Glass */
  --shadow: 0 24px 70px rgba(2,6,23,.28);

  --meBg: rgba(219,234,254,.92);
  --botBg: rgba(255,255,255,.88);
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  color:var(--text);
  background:#0b1220;
  overflow-x:hidden;
  -webkit-text-size-adjust:100%;
}

/* D≈ÆLE≈ΩIT√â: aby hidden opravdu schoval prvky */
[hidden]{ display:none !important; }

/* ====== BACKGROUND (Radim web screenshot) ====== */
.bg{
  position:fixed; inset:0; z-index:0;
  background:
    radial-gradient(1200px 700px at 25% 0%, rgba(29,78,216,.22), transparent 60%),
    radial-gradient(900px 600px at 85% 15%, rgba(255,255,255,.10), transparent 55%),
    linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,0)),
    #0b1220;
}
.bgImg{
  position:absolute; inset:0;
  background-size:cover;
  background-position:top center;
  filter:saturate(1.02) contrast(1.02);
  opacity:.92;
  transform:scale(1.02);
}
.bg::after{
  content:"";
  position:absolute; inset:0;
  background: linear-gradient(90deg, rgba(11,18,32,.78), rgba(11,18,32,.42));
  pointer-events:none;
}
.bgVignette{
  position:absolute; inset:0;
  background: radial-gradient(1200px 900px at 30% 15%, transparent 42%, rgba(0,0,0,.58) 100%);
  pointer-events:none;
}

/* ====== CHAT WIDGET ====== */
.chat-widget{
  position:fixed;
  right:20px;
  bottom:20px;
  width:392px;
  height:640px;

  background: rgba(255,255,255,.10);
  border:1px solid rgba(255,255,255,.16);
  border-radius:22px;
  box-shadow: var(--shadow);
  backdrop-filter: blur(14px);

  display:none;
  flex-direction:column;
  overflow:hidden;
  z-index:9999;
}

/* HEADER */
.chat-header{
  padding:12px 12px;
  background: linear-gradient(135deg, rgba(30,58,138,.92), rgba(21,48,111,.88));
  color:#fff;
  cursor:pointer;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  border-bottom: 1px solid rgba(255,255,255,.12);
}

.header-left{display:flex;gap:10px;align-items:center;min-width:0}

/* ERB (vƒõt≈°√≠ + ƒçistƒõ v rohu modr√© hlaviƒçky) */
.brandmark{
  width:52px;height:52px;border-radius:16px;
  background:rgba(255,255,255,.14);
  border:1px solid rgba(255,255,255,.16);
  display:flex;align-items:center;justify-content:center;
  overflow:hidden;
  flex:0 0 auto;
}
.brandmark img{
  width:100%;
  height:100%;
  object-fit:contain;
  display:block;
  padding:6px; /* aby se erb nedot√Ωkal okraj≈Ø */
}

.header-title{
  font-weight:950;
  font-size:14px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis
}

.header-right{display:flex;align-items:center;gap:8px;flex:0 0 auto}
.chip{
  font-size:11px;
  padding:4px 10px;
  border-radius:999px;
  background:rgba(255,255,255,.14);
  border:1px solid rgba(255,255,255,.14);
}
.toggle{font-size:18px;opacity:.9}

/* CHAT AREA (transparent) */
.chat{
  flex:1;
  padding:14px 12px 10px;
  overflow-y:auto;
  display:flex;
  flex-direction:column;
  gap:10px;
  background: transparent;
}

/* Messages */
.msg{
  max-width: 86%;
  padding: 10px 12px;
  border-radius: 16px;
  font-size: 13px;
  line-height: 1.45;
  white-space: pre-wrap;
  word-break: break-word;
  border: 1px solid rgba(255,255,255,.18);
  box-shadow: 0 10px 28px rgba(0,0,0,.16);
  animation: pop .16s ease-out;
}
@keyframes pop{
  from{ transform: translateY(4px) scale(.985); opacity:0; }
  to{ transform: translateY(0) scale(1); opacity:1; }
}
.me{
  align-self:flex-end;
  background: var(--meBg);
  border-bottom-right-radius: 8px;
}
.bot{
  align-self:flex-start;
  background: var(--botBg);
  border-bottom-left-radius: 8px;
}
.msg strong{font-weight:900}
.msg a{color:var(--brand2);word-break:break-word;text-decoration:none}
.msg a:hover{text-decoration:underline}

/* ===== Quick FAQ chips (jako demo) ===== */
.quickbox{
  margin: 0 12px 10px 12px;
  padding: 12px;
  border-radius: 16px;
  background: rgba(255,255,255,.10);
  border:1px solid rgba(255,255,255,.14);
  backdrop-filter: blur(10px);
}
.quicktitle{
  font-weight:950;
  font-size:12px;
  color: rgba(255,255,255,.92);
  margin:0 0 10px 0;
}
.quickgrid{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
}
.qbtn{
  appearance:none;
  border:1px solid rgba(255,255,255,.16);
  background: rgba(0,0,0,.18);
  color:#fff;
  border-radius:999px;
  padding:8px 10px;
  font-size:12px;
  font-weight:900;
  cursor:pointer;
}
.qbtn:hover{ background: rgba(0,0,0,.26); }

/* INPUT */
.row{
  display:flex;
  gap:10px;
  padding:10px 12px 12px;
  border-top:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  backdrop-filter: blur(10px);
}

/* POLE PRO PSAN√ç ‚Äì tmav≈°√≠, jasnƒõ viditeln√© */
input{
  flex:1;
  height:46px;
  padding:0 14px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.20);
  background: rgba(0,0,0,.32);       /* tmav≈°√≠ ne≈æ p≈ôedt√≠m */
  color:#fff;
  font-size:16px; /* iOS zoom fix */
  outline:none;
  box-shadow: inset 0 0 0 1px rgba(0,0,0,.08);
}
input::placeholder{color: rgba(255,255,255,.78)}

/* TLACITKO POSLAT ‚Äì v√Ωraznƒõj≈°√≠ */
button.send{
  width:46px;
  height:46px;
  border:1px solid rgba(0,229,255,.24);
  border-radius:14px;
  background: linear-gradient(135deg, rgba(0,229,255,.22), rgba(29,78,216,.22));
  color:#fff;
  font-weight:950;
  cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  box-shadow: 0 10px 26px rgba(0,0,0,.22);
}
button.send:hover{
  background: linear-gradient(135deg, rgba(0,229,255,.28), rgba(29,78,216,.26));
}
button.send:disabled{opacity:.55;cursor:not-allowed}

/* ===== FLOATING TAB ===== */
.radim-fab{
  position:fixed;
  right:20px;
  bottom:20px;
  height:56px;
  padding:10px 12px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.18);
  cursor:pointer;

  background: rgba(10,16,28,.60);
  backdrop-filter: blur(12px);
  box-shadow: 0 18px 55px rgba(0,0,0,.45);
  color:#fff;

  display:flex;
  align-items:center;
  gap:10px;
  z-index:10000;

  animation: pulse 1.8s infinite ease-in-out;
}
@keyframes pulse{
  0%,100%{ box-shadow: 0 18px 55px rgba(0,0,0,.45); }
  50%{ box-shadow: 0 18px 55px rgba(29,78,216,.32); }
}
.fabIcon{
  width:38px;height:38px;border-radius:14px;
  background: rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.14);
  display:flex;align-items:center;justify-content:center;
  overflow:hidden;
  flex:0 0 auto;
}
.fabIcon img{
  width:100%;
  height:100%;
  object-fit:contain;
  display:block;
  padding:6px;
}
.fabText{display:flex;flex-direction:column;line-height:1.05;min-width:0}
.fabText .a{font-weight:950;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:220px}
.fabText .b{font-size:11px;color:rgba(255,255,255,.72);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:220px}

/* ===== Loading: animated dots ===== */
.loading-bar{
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px 12px;
  margin:0 12px 10px 12px;
  border-radius:14px;
  background: rgba(255,255,255,.10);
  border:1px solid rgba(255,255,255,.14);
  font-size:13px;
  color: rgba(255,255,255,.80);
  backdrop-filter: blur(10px);
}
.typing{
  display:inline-flex;
  gap:6px;
  align-items:center;
}
.typing span{
  width:7px;height:7px;border-radius:999px;
  background: rgba(255,255,255,.92);
  opacity:.35;
  animation:bounce 1s infinite ease-in-out;
}
.typing span:nth-child(2){animation-delay:.12s}
.typing span:nth-child(3){animation-delay:.24s}
@keyframes bounce{
  0%,100%{transform:translateY(0);opacity:.35}
  50%{transform:translateY(-4px);opacity:1}
}

/* Feedback */
.feedback{
  margin:0 12px 10px 12px;
  padding:12px;
  border-radius:16px;
  background: rgba(255,255,255,.10);
  border:1px solid rgba(255,255,255,.14);
  font-size:13px;
  color: rgba(255,255,255,.92);
  backdrop-filter: blur(10px);
}
.feedback-q{ margin-bottom:10px; font-weight:950; }
.feedback-actions{ display:flex; gap:8px; }
.feedback-actions button{
  padding:9px 10px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.18);
  background: rgba(255,255,255,.10);
  cursor:pointer;
  font-weight:950;
  color:#fff;
}
.feedback-actions button:hover{ background: rgba(255,255,255,.14); }
.feedback-actions button:disabled{ opacity:.55; cursor:not-allowed; }

/* Mobile */
@media(max-width:480px){
  .chat-widget{right:12px;left:12px;bottom:12px;width:auto;height:80vh}
  .radim-fab{right:12px;bottom:12px}
}

/* Reduce motion */
@media (prefers-reduced-motion: reduce){
  .radim-fab{animation:none}
  .msg{animation:none}
  .typing span{animation:none}
}
</style>
</head>

<body>

<!-- Background layer -->
<div class="bg" aria-hidden="true">
  <div class="bgImg" id="bgImg"></div>
  <div class="bgVignette"></div>
</div>

<!-- CHAT -->
<div id="widget" class="chat-widget" role="dialog" aria-label="Chat ‚Äì Asistent obce Radim">
  <div class="chat-header" onclick="closeChat()">
    <div class="header-left">
      <div class="brandmark" id="brandmark">
        <span id="brandFallback" style="font-size:14px;font-weight:950;">AI</span>
      </div>
      <div style="min-width:0;">
        <div class="header-title">Asistent obce Radim</div>
      </div>
    </div>
    <div class="header-right">
      <div class="chip">Online</div>
      <span class="toggle">‚åÑ</span>
    </div>
  </div>

  <div id="chat" class="chat"></div>

  <!-- Nejƒçastƒõj≈°√≠ dotazy -->
  <div id="quickBox" class="quickbox">
    <div class="quicktitle">Nejƒçastƒõj≈°√≠ dotazy</div>
    <div class="quickgrid">
      <button class="qbtn" data-q="Jak√© je ƒç√≠slo na starostku?">ƒå√≠slo na starostku</button>
      <button class="qbtn" data-q="Jak√© jsou kontakty na obecn√≠ √∫≈ôad?">Kontakty √∫≈ôadu</button>
      <button class="qbtn" data-q="Kde je biodopad a jak√° je otev√≠rac√≠ doba?">Biodopad</button>
      <button class="qbtn" data-q="Kdy je svoz komun√°ln√≠ho odpadu?">Svoz odpadu</button>
      <button class="qbtn" data-q="Jak√© jsou poplatky za odpady a psa?">Poplatky</button>
      <button class="qbtn" data-q="Kde najdu formul√°≈ôe a ≈æ√°dosti?">Formul√°≈ôe</button>
    </div>
  </div>

  <!-- Loading li≈°ta -->
  <div id="loadingBar" class="loading-bar" hidden>
    <span class="typing" aria-label="Generuje se odpovƒõƒè">
      <span></span><span></span><span></span>
    </span>
    <span>Generuje se odpovƒõƒè‚Ä¶</span>
  </div>

  <!-- Feedback li≈°ta -->
  <div id="feedbackBox" class="feedback" hidden>
    <div class="feedback-q">Na≈°li jste odpovƒõƒè na ot√°zku?</div>
    <div class="feedback-actions">
      <button type="button" id="feedbackYes">Ano</button>
      <button type="button" id="feedbackNo">Ne</button>
    </div>
  </div>

  <div class="row">
    <input id="q" type="text" placeholder="Napi≈°te dotaz‚Ä¶" />
    <button id="send" class="send" aria-label="Odeslat">‚û§</button>
  </div>
</div>

<!-- Floating tab -->
<button id="fab" class="radim-fab" onclick="openChat()">
  <div class="fabIcon" id="fabIcon">
    <span id="fabFallback" style="font-size:12px;font-weight:950;">AI</span>
  </div>
  <div class="fabText">
    <div class="a">Porad√≠me v√°m</div>
    <div class="b">Kliknƒõte a napi≈°te dotaz‚Ä¶</div>
  </div>
</button>

<script>
const chatEl=document.getElementById("chat");
const input=document.getElementById("q");
const send=document.getElementById("send");
const widget=document.getElementById("widget");
const fab=document.getElementById("fab");

const loadingBar=document.getElementById("loadingBar");
const feedbackBox=document.getElementById("feedbackBox");
const feedbackYes=document.getElementById("feedbackYes");
const feedbackNo=document.getElementById("feedbackNo");

const bgImg = document.getElementById("bgImg");
const brandmark = document.getElementById("brandmark");
const brandFallback = document.getElementById("brandFallback");
const fabIcon = document.getElementById("fabIcon");
const fabFallback = document.getElementById("fabFallback");

const quickBox = document.getElementById("quickBox");

// --- Assets (Radim)
const BG_URL = "/skins/radim/bg.jpg";
const ERB_URL = "/skins/radim/erb.png"; // erb ve slo≈æce skins/radim

// DOPL≈á kontakt na √∫≈ôad (voliteln√© ‚Äì kdy≈æ chce≈° pou≈æ√≠t ve fallback odpovƒõdi)
const OFFICE_PHONE = "DOPL≈á_TEL_NA_√ö≈òAD";
const OFFICE_EMAIL = "";

let userQuestionCount = 0;
let awaitingFeedback = false;

function openChat(){
  widget.style.display="flex";
  fab.style.display="none";
  setTimeout(()=>input.focus(),100);
}
function closeChat(){
  widget.style.display="none";
  fab.style.display="flex";
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
}
function linkify(t){
  const s=escapeHtml(t);
  return s.replace(/(https?:\/\/[^\s]+)/g,u=>`<a href="${u}" target="_blank" rel="noopener noreferrer">${u}</a>`);
}
function addMessage(who,text,cls){
  const d=document.createElement("div");
  d.className="msg "+cls;
  const cleaned = String(text || "").replace(/\d+\:\d+‚Ä†source/g,"");
  d.innerHTML=`<strong>${who}:</strong> ${linkify(cleaned)}`;
  chatEl.appendChild(d);
  chatEl.scrollTop=chatEl.scrollHeight;
}

function showLoading(on){
  loadingBar.hidden = !on;
  if(on) feedbackBox.hidden = true;
  chatEl.scrollTop = chatEl.scrollHeight;
}

function showFeedback(){
  if(userQuestionCount < 2) return;
  if(awaitingFeedback) return;
  awaitingFeedback = true;
  feedbackBox.hidden = false;
  chatEl.scrollTop = chatEl.scrollHeight;
}
function hideFeedback(){
  feedbackBox.hidden = true;
  awaitingFeedback = false;
}

feedbackYes.onclick = () => {
  hideFeedback();
  addMessage("Radim","Super üôÇ Jsem r√°d, ≈æe jsem pomohl. Kdykoliv se zeptejte znovu.","bot");
};

feedbackNo.onclick = () => {
  hideFeedback();
  let msg = "Mrz√≠ mƒõ to. Zkuste pros√≠m dotaz up≈ôesnit (nap≈ô. m√≠sto, term√≠n, n√°zev dokumentu).\n\n";
  msg += "Je mo≈æn√©, ≈æe tato informace nen√≠ dostupn√° na webu obce. V takov√©m p≈ô√≠padƒõ doporuƒçuji obr√°tit se p≈ô√≠mo na obecn√≠ √∫≈ôad.";
  if(OFFICE_PHONE && !OFFICE_PHONE.includes("DOPL≈á")){
    msg += `\nTelefon: ${OFFICE_PHONE}`;
  }
  if(OFFICE_EMAIL){
    msg += `\nE-mail: ${OFFICE_EMAIL}`;
  }
  addMessage("Radim",msg,"bot");
};

async function ask(){
  const q=input.value.trim();
  if(!q) return;

  feedbackBox.hidden = true;

  addMessage("Vy",q,"me");
  input.value="";
  send.disabled=true;
  userQuestionCount++;

  // po prvn√≠ interakci m≈Ø≈æe≈° quickBox nechat nebo schovat:
  // quickBox.hidden = true;

  showLoading(true);

  try{
    const r=await fetch("/.netlify/functions/search",{
      method:"POST",
      headers:{ "content-type":"application/json" },
      body:JSON.stringify({ message:q })
    });
    const j=await r.json().catch(()=>({}));
    addMessage("Radim", (j && j.answer) ? j.answer : "Bez odpovƒõdi", "bot");
    showFeedback();
  }catch(e){
    addMessage("Radim","Chyba spojen√≠.","bot");
  }finally{
    showLoading(false);
    send.disabled=false;
  }
}

send.onclick=ask;
input.addEventListener("keydown",e=>e.key==="Enter"&&ask());

// Quick buttons -> po≈°lou dotaz
document.querySelectorAll(".qbtn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    input.value = btn.dataset.q || btn.textContent.trim();
    ask();
  });
});

// === Load background reliably (no HEAD) ===
(function loadBg(){
  const img = new Image();
  img.onload = () => { bgImg.style.backgroundImage = `url('${BG_URL}')`; };
  img.onerror = () => { bgImg.style.backgroundImage = ""; };
  img.src = BG_URL + "?v=" + Date.now();
})();

// === Load erb into header + floating tab ===
(function loadErb(){
  const img = new Image();
  img.onload = () => {
    // header
    brandmark.innerHTML = "";
    const h = document.createElement("img");
    h.src = ERB_URL;
    h.alt = "Erb obce Radim";
    brandmark.appendChild(h);

    // fab
    fabIcon.innerHTML = "";
    const f = document.createElement("img");
    f.src = ERB_URL;
    f.alt = "Erb obce Radim";
    fabIcon.appendChild(f);
  };
  img.onerror = () => {
    brandFallback.style.display = "inline";
    fabFallback.style.display = "inline";
  };
  img.src = ERB_URL + "?v=" + Date.now();
})();

// INIT ‚Äì disclaimer + uv√≠t√°n√≠
addMessage(
  "Radim",
  "Upozornƒõn√≠:\nOdpovƒõdi tohoto asistenta jsou generov√°ny umƒõlou inteligenc√≠ na z√°kladƒõ dostupn√Ωch informac√≠.\nPr√°vnƒõ z√°vazn√© a ofici√°ln√≠ informace si v≈ædy ovƒõ≈ôte na ofici√°ln√≠m webu obce Radim nebo p≈ô√≠mo na obecn√≠m √∫≈ôadƒõ.",
  "bot"
);
addMessage("Radim","Ahoj! Zeptej se mƒõ na cokoliv ohlednƒõ obce Radim.","bot");
</script>

</body>
</html>
