<!doctype html>
<html lang="cs">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Asistent obce Radim</title>

<style>
:root{
  --bg: #f4f6fb;
  --card: #ffffff;
  --text: #0f172a;
  --muted: #475569;
  --border: #e5e7eb;

  --brand: #1e3a8a;      /* hlavn√≠ modr√° */
  --brand-2:#1d4ed8;     /* akcent */
  --me: #dbeafe;         /* bublina u≈æivatele */
  --bot: #ffffff;        /* bublina bota */
  --shadow: 0 18px 50px rgba(2, 6, 23, .16);
}

*{ box-sizing:border-box; }
body{
  margin:0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  background: transparent;
  color: var(--text);
}

/* === WIDGET === */
.chat-widget{
  position: fixed;
  right: 24px;
  bottom: 24px;

  width: 380px;
  height: 600px;

  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 18px;
  box-shadow: var(--shadow);

  display:flex;
  flex-direction:column;
  overflow:hidden;
  z-index:9999;

  transform-origin: bottom right;
  transition: height .22s ease, width .22s ease, transform .22s ease;
}

/* collapsed = jen hlaviƒçka */
.chat-widget.collapsed{
  height: 56px;
  width: 240px;
}

/* HLAVIƒåKA */
.chat-header{
  padding: 12px 14px;
  background: linear-gradient(135deg, var(--brand), #15306f);
  color:#fff;
  cursor:pointer;
  user-select:none;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}

.header-left{
  display:flex;
  align-items:center;
  gap:10px;
  min-width:0;
}

.brandmark{
  width: 34px;
  height: 34px;
  border-radius: 10px;
  background: rgba(255,255,255,.14);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size: 18px;
}

.header-titles{
  display:flex;
  flex-direction:column;
  line-height:1.1;
  min-width:0;
}

.header-title{
  font-weight: 750;
  font-size: 14.5px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.header-subtitle{
  font-size: 11.5px;
  opacity: .85;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.header-right{
  display:flex;
  align-items:center;
  gap:10px;
}

.chip{
  font-size: 11px;
  padding: 4px 8px;
  border-radius: 999px;
  background: rgba(255,255,255,.14);
  border: 1px solid rgba(255,255,255,.18);
  display:flex;
  align-items:center;
  gap:6px;
}
.dot{
  width:7px;height:7px;border-radius:50%;
  background:#34d399;
  box-shadow: 0 0 0 3px rgba(52,211,153,.18);
}

.toggle{
  font-size: 18px;
  opacity:.95;
}

/* tƒõlo chatu */
.chat{
  display:flex;
  flex-direction:column;
  gap:10px;
  padding: 14px;
  overflow-y:auto;
  flex:1;
  background: var(--bg);
}

/* hezƒç√≠ scrollbar (jen webkit) */
.chat::-webkit-scrollbar{ width:10px; }
.chat::-webkit-scrollbar-thumb{
  background: rgba(15,23,42,.12);
  border-radius: 999px;
  border: 2px solid rgba(244,246,251,1);
}

/* bubliny */
.msg{
  max-width: 86%;
  padding: 10px 12px;
  border-radius: 14px;
  font-size: 14px;
  line-height: 1.45;
  white-space: pre-wrap;
  pointer-events:auto;
  position:relative;
}

.msg strong{ font-weight: 700; }

.msg a{
  color: var(--brand-2);
  text-decoration: underline;
  pointer-events:auto;
  cursor:pointer;
  word-break: break-word;
}

/* user */
.me{
  background: var(--me);
  align-self:flex-end;
  border-bottom-right-radius: 6px;
  box-shadow: 0 6px 14px rgba(2,6,23,.06);
}

/* bot */
.bot{
  background: var(--bot);
  border: 1px solid var(--border);
  align-self:flex-start;
  border-bottom-left-radius: 6px;
  box-shadow: 0 10px 24px rgba(2,6,23,.07);
}

/* pozn√°mka */
.ai-note{
  font-size: 11.5px;
  color: #854d0e;
  background: #fef3c7;
  border: 1px solid #fde68a;
  border-radius: 12px;
  padding: 10px 12px;
}

/* feedback */
.feedback{
  display:flex;
  gap:8px;
  margin-top: 8px;
}

.feedback button{
  flex:1;
  font-size: 13px;
  padding: 8px;
  border-radius: 12px;
  border: 1px solid #c7d2fe;
  background: #eef2ff;
  cursor:pointer;
  transition: transform .06s ease, background .12s ease;
}
.feedback button:active{ transform: scale(.98); }
.feedback button.clicked{
  background: var(--brand);
  border-color: rgba(255,255,255,.25);
  color:#fff;
}

/* input ≈ô√°dek */
.row{
  display:flex;
  border-top: 1px solid var(--border);
  background: #fff;
  padding: 10px;
  gap: 8px;
}

input{
  flex:1;
  padding: 10px 12px;
  border: 1px solid var(--border);
  border-radius: 12px;
  font-size: 14px;
  outline:none;
  background:#fff;
}
input:focus{
  border-color: rgba(29,78,216,.55);
  box-shadow: 0 0 0 4px rgba(29,78,216,.12);
}

button.send{
  width: 44px;
  border: 0;
  border-radius: 12px;
  background: var(--brand);
  color:#fff;
  font-weight: 800;
  cursor:pointer;
  transition: transform .06s ease, background .12s ease;
}
button.send:hover{ background:#15306f; }
button.send:active{ transform: scale(.98); }
button:disabled{ opacity:.6; cursor:not-allowed; }

/* typing */
.typing{
  font-size: 13px;
  color: var(--muted);
  background: #ffffff;
  border: 1px dashed #cbd5e1;
  align-self:flex-start;
}
.dots{
  display:inline-flex;
  gap:4px;
  margin-left: 6px;
  vertical-align: middle;
}
.dots span{
  width:6px;height:6px;border-radius:50%;
  background: rgba(71,85,105,.55);
  animation: bounce 1.1s infinite ease-in-out;
}
.dots span:nth-child(2){ animation-delay: .12s; }
.dots span:nth-child(3){ animation-delay: .24s; }
@keyframes bounce{
  0%, 80%, 100%{ transform: translateY(0); opacity:.55; }
  40%{ transform: translateY(-4px); opacity:1; }
}

/* collapsed schov√° tƒõlo + input */
.chat-widget.collapsed .chat,
.chat-widget.collapsed .row{
  display:none;
}

/* mobil: skoro fullscreen */
@media (max-width: 480px){
  .chat-widget{
    right: 12px;
    left: 12px;
    bottom: 12px;
    width: auto;
    height: 78vh;
    border-radius: 18px;
  }
  .chat-widget.collapsed{
    height: 56px;
    width: auto;
  }
}
</style>
</head>

<body>

<div id="widget" class="chat-widget">
  <div class="chat-header" onclick="toggleWidget()">
    <div class="header-left">
      <div class="brandmark">üèõÔ∏è</div>
      <div class="header-titles">
        <div class="header-title">Asistent obce Radim</div>
        <div class="header-subtitle">Informace z ofici√°ln√≠ho webu</div>
      </div>
    </div>

    <div class="header-right">
      <div class="chip"><span class="dot"></span>Online</div>
      <span id="arrow" class="toggle">‚åÑ</span>
    </div>
  </div>

  <div id="chat" class="chat"></div>

  <div class="row">
    <input id="q" type="text" placeholder="Napi≈°te dotaz‚Ä¶" autocomplete="off" />
    <button id="send" class="send" aria-label="Odeslat">‚Ä∫</button>
  </div>
</div>

<script>
const chatEl = document.getElementById("chat");
const inputEl = document.getElementById("q");
const sendBtn = document.getElementById("send");
const widget = document.getElementById("widget");
const arrow = document.getElementById("arrow");

let aiNoteShown = false;
let questionCount = 0;
let feedbackShown = false;
let typingEl = null;

function toggleWidget() {
  widget.classList.toggle("collapsed");
  arrow.textContent = widget.classList.contains("collapsed") ? "‚åÉ" : "‚åÑ";
  if (!widget.classList.contains("collapsed")) {
    setTimeout(() => inputEl.focus(), 80);
  }
}

/* ochrana proti HTML + p≈ôevod URL na <a> */
function escapeHtml(s) {
  return String(s)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

function linkify(text) {
  const safe = escapeHtml(text);
  const urlRegex = /(https?:\/\/[^\s]+)/g;
  return safe.replace(urlRegex, (url) =>
    `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`
  );
}

/* odstran√≠ intern√≠ citace typu (4:3‚Ä†source) */
function stripInternalCitations(text){
  return String(text).replace(/\(\d+:\d+‚Ä†source\)/g, "").replace(/\s{2,}/g," ").trim();
}

function addMessage(who, text, cls) {
  const div = document.createElement("div");
  div.className = "msg " + cls;

  const safeWho = escapeHtml(who);
  const cleaned = stripInternalCitations(text);

  div.innerHTML = `<strong>${safeWho}:</strong> ${linkify(cleaned)}`;

  chatEl.appendChild(div);
  chatEl.scrollTop = chatEl.scrollHeight;
}

function addAiNoteOnce() {
  if (aiNoteShown) return;
  aiNoteShown = true;

  const div = document.createElement("div");
  div.className = "ai-note";
  div.textContent =
    "Upozornƒõn√≠: Odpovƒõdi jsou generov√°ny umƒõlou inteligenc√≠ a maj√≠ informativn√≠ charakter. Pro ofici√°ln√≠ a z√°vazn√© informace doporuƒçujeme ovƒõ≈ôit √∫daje na webu obce Radim.";
  chatEl.appendChild(div);
  chatEl.scrollTop = chatEl.scrollHeight;
}

/* typing */
function showTyping() {
  if (typingEl) return;
  typingEl = document.createElement("div");
  typingEl.className = "msg bot typing";
  typingEl.innerHTML = `
    <strong>Radim:</strong> Hled√°m odpovƒõƒè
    <span class="dots"><span></span><span></span><span></span></span>
  `;
  chatEl.appendChild(typingEl);
  chatEl.scrollTop = chatEl.scrollHeight;
}
function hideTyping() {
  if (!typingEl) return;
  typingEl.remove();
  typingEl = null;
}

function addFeedbackOnce() {
  if (feedbackShown) return;
  feedbackShown = true;

  const label = document.createElement("div");
  label.className = "ai-note";
  label.textContent = "Vy≈ôe≈°ili jste sv≈Øj dotaz?";

  const wrap = document.createElement("div");
  wrap.className = "feedback";

  const yes = document.createElement("button");
  const no = document.createElement("button");

  yes.textContent = "Ano";
  no.textContent = "Ne";

  yes.onclick = () => {
    yes.classList.add("clicked");
    no.disabled = true;
    yes.disabled = true;
    addMessage("Radim", "Jsem r√°d, ≈æe jsem pomohl. Pokud budete pot≈ôebovat je≈°tƒõ nƒõco dal≈°√≠ho, jsem v√°m k dispozici.", "bot");
  };

  no.onclick = () => {
    no.classList.add("clicked");
    yes.disabled = true;
    no.disabled = true;
    addMessage("Radim", "Mrz√≠ mƒõ, ≈æe se dotaz nepovedlo vy≈ôe≈°it. M≈Ø≈æete ho pros√≠m up≈ôesnit (co p≈ôesnƒõ hled√°te / jak√° ƒç√°st chyb√≠)?", "bot");
  };

  wrap.appendChild(yes);
  wrap.appendChild(no);

  chatEl.appendChild(label);
  chatEl.appendChild(wrap);
  chatEl.scrollTop = chatEl.scrollHeight;
}

async function ask() {
  const query = inputEl.value.trim();
  if (!query) return;

  if (widget.classList.contains("collapsed")) toggleWidget();

  addMessage("Vy", query, "me");
  inputEl.value = "";
  sendBtn.disabled = true;
  questionCount++;

  try {
    addAiNoteOnce();
    showTyping();

    const res = await fetch("/.netlify/functions/search", {
      method: "POST",
      headers: { "content-type": "application/json" },
      body: JSON.stringify({ message: query })
    });

    const raw = await res.text();
    let data;
    try { data = JSON.parse(raw); }
    catch { throw new Error("Server nevr√°til JSON."); }

    hideTyping();

    if (!res.ok || !data.ok) {
      addMessage("Radim", data?.error || "Chyba serveru", "bot");
      return;
    }

    addMessage("Radim", data.answer || "(bez odpovƒõdi)", "bot");

    if (questionCount === 2) addFeedbackOnce();

  } catch (e) {
    hideTyping();
    addMessage("Radim", "Chyba: " + e.message, "bot");
  } finally {
    sendBtn.disabled = false;
    inputEl.focus();
  }
}

// init
sendBtn.addEventListener("click", ask);
inputEl.addEventListener("keydown", e => {
  if (e.key === "Enter") ask();
});

// prvn√≠ zpr√°va
addMessage("Radim", "Ahoj! Zeptej se mƒõ na cokoliv ohlednƒõ obce Radim.", "bot");
addAiNoteOnce();
</script>

</body>
</html>
