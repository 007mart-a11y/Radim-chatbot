<!doctype html>
<html lang="cs">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Asistent obce Radim</title>

<style>
body {
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  background: transparent;
}

/* === WIDGET === */
.chat-widget {
  position: fixed;
  right: 24px;
  bottom: 24px;
  width: 360px;
  max-height: 540px;
  background: #ffffff;
  border-radius: 16px;
  box-shadow: 0 12px 35px rgba(0,0,0,.18);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  border: 1px solid #e5e7eb;
  z-index: 9999;
}

.chat-widget.collapsed {
  height: 48px;
  width: 220px;
}

.chat-header {
  background: #1e3a8a;
  color: #fff;
  padding: 12px 14px;
  font-weight: 700;
  font-size: 15px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
}

.toggle { font-size: 18px; }

.chat {
  display: flex;
  flex-direction: column;
  gap: 8px;
  padding: 12px;
  overflow-y: auto;
  flex: 1;
  background: #f8fafc;
}

.msg {
  padding: 8px 10px;
  border-radius: 10px;
  font-size: 14px;
  line-height: 1.35;
  white-space: pre-wrap;
  pointer-events: auto;
}

.msg a {
  color: #1e40af;
  text-decoration: underline;
  pointer-events: auto;
  cursor: pointer;
  word-break: break-word;
}

.me {
  background: #dbeafe;
  align-self: flex-end;
}

.bot {
  background: #ffffff;
  border: 1px solid #e5e7eb;
  align-self: flex-start;
}

.ai-note {
  font-size: 11px;
  background: #fef3c7;
  border: 1px solid #fde68a;
  color: #92400e;
  border-radius: 8px;
  padding: 8px;
}

.feedback {
  display: flex;
  gap: 8px;
  margin-top: 6px;
}

.feedback button {
  flex: 1;
  font-size: 13px;
  padding: 6px;
  border-radius: 8px;
  border: 1px solid #c7d2fe;
  background: #eef2ff;
  cursor: pointer;
}

.feedback button.clicked {
  background: #1e3a8a;
  color: #fff;
}

.row {
  display: flex;
  border-top: 1px solid #e5e7eb;
}

input {
  flex: 1;
  padding: 10px;
  border: none;
  font-size: 14px;
  outline: none;
}

button.send {
  padding: 0 14px;
  border: 0;
  background: #1e3a8a;
  color: #fff;
  font-weight: 600;
  cursor: pointer;
}

button:disabled { opacity: .6; }

/* ✅ “Radim píše…” */
.typing {
  font-size: 13px;
  color: #334155;
  background: #ffffff;
  border: 1px dashed #cbd5e1;
  align-self: flex-start;
}
.dots::after{
  content: "";
  display: inline-block;
  width: 1.5em;
  text-align: left;
  animation: dots 1.2s steps(4, end) infinite;
}
@keyframes dots {
  0%   { content: ""; }
  25%  { content: "."; }
  50%  { content: ".."; }
  75%  { content: "..."; }
  100% { content: ""; }
}
</style>
</head>

<body>

<div id="widget" class="chat-widget">
  <div class="chat-header" onclick="toggleWidget()">
    Asistent obce Radim
    <span id="arrow" class="toggle">⌄</span>
  </div>

  <div id="chat" class="chat"></div>

  <div class="row">
    <input id="q" type="text" placeholder="Napište dotaz…" autocomplete="off" />
    <button id="send" class="send">›</button>
  </div>
</div>

<script>
const chatEl = document.getElementById("chat");
const inputEl = document.getElementById("q");
const sendBtn = document.getElementById("send");
const widget = document.getElementById("widget");
const arrow = document.getElementById("arrow");

let aiNoteShown = false;
let questionCount = 0;
let feedbackShown = false;

// ✅ typing indikátor (bublina)
let typingEl = null;

function toggleWidget() {
  widget.classList.toggle("collapsed");
  arrow.textContent = widget.classList.contains("collapsed") ? "⌃" : "⌄";
}

/* ✅ ochrana proti HTML + převod URL na <a> */
function escapeHtml(s) {
  return String(s)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

function linkify(text) {
  const safe = escapeHtml(text);
  const urlRegex = /(https?:\/\/[^\s]+)/g;
  return safe.replace(urlRegex, (url) =>
    `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`
  );
}

function addMessage(who, text, cls) {
  const div = document.createElement("div");
  div.className = "msg " + cls;

  const safeWho = escapeHtml(who);
  div.innerHTML = `<strong>${safeWho}:</strong> ${linkify(text)}`;

  chatEl.appendChild(div);
  chatEl.scrollTop = chatEl.scrollHeight;
}

function addAiNoteOnce() {
  if (aiNoteShown) return;
  aiNoteShown = true;

  const div = document.createElement("div");
  div.className = "ai-note";
  div.textContent =
    "Upozornění: Odpovědi jsou generovány umělou inteligencí a mají informativní charakter. Pro oficiální a závazné informace doporučujeme ověřit údaje na webu obce Radim.";
  chatEl.appendChild(div);
}

/* ✅ zobrazí / skryje “Radim píše…” */
function showTyping() {
  if (typingEl) return;
  typingEl = document.createElement("div");
  typingEl.className = "msg bot typing";
  typingEl.innerHTML = `<strong>Radim:</strong> <span class="dots">Hledám odpověď</span>`;
  chatEl.appendChild(typingEl);
  chatEl.scrollTop = chatEl.scrollHeight;
}

function hideTyping() {
  if (!typingEl) return;
  typingEl.remove();
  typingEl = null;
}

function addFeedbackOnce() {
  if (feedbackShown) return;
  feedbackShown = true;

  const label = document.createElement("div");
  label.className = "ai-note";
  label.textContent = "Vyřešili jste svůj dotaz?";

  const wrap = document.createElement("div");
  wrap.className = "feedback";

  const yes = document.createElement("button");
  const no = document.createElement("button");

  yes.textContent = "Ano";
  no.textContent = "Ne";

  yes.onclick = () => {
    yes.classList.add("clicked");
    no.disabled = true;
    yes.disabled = true;

    addMessage("Radim", "Jsem rád, že jsem pomohl. Pokud budete potřebovat ještě něco dalšího, jsem vám k dispozici.", "bot");
  };

  no.onclick = () => {
    no.classList.add("clicked");
    yes.disabled = true;
    no.disabled = true;

    addMessage("Radim", "Mrzí mě, že se dotaz nepovedlo vyřešit. Můžete ho prosím lépe specifikovat (co přesně hledáte / jaká část chybí)?", "bot");
  };

  wrap.appendChild(yes);
  wrap.appendChild(no);

  chatEl.appendChild(label);
  chatEl.appendChild(wrap);
  chatEl.scrollTop = chatEl.scrollHeight;
}

async function ask() {
  const query = inputEl.value.trim();
  if (!query) return;

  addMessage("Vy", query, "me");
  inputEl.value = "";
  sendBtn.disabled = true;

  questionCount++;

  try {
    addAiNoteOnce();
    showTyping();

    const res = await fetch("/.netlify/functions/search", {
      method: "POST",
      headers: { "content-type": "application/json" },
      body: JSON.stringify({ message: query })
    });

    const raw = await res.text();
    let data;
    try { data = JSON.parse(raw); }
    catch { throw new Error("Server nevrátil JSON."); }

    if (!res.ok || !data.ok) {
      hideTyping();
      addMessage("Radim", data?.error || "Chyba serveru", "bot");
      return;
    }

    hideTyping();
    addMessage("Radim", data.answer || "(bez odpovědi)", "bot");

    if (questionCount === 2) {
      addFeedbackOnce();
    }

  } catch (e) {
    hideTyping();
    addMessage("Radim", "Chyba: " + e.message, "bot");
  } finally {
    sendBtn.disabled = false;
  }
}

// init
sendBtn.addEventListener("click", ask);
inputEl.addEventListener("keydown", e => e.key === "Enter" && ask());

addMessage("Radim", "Ahoj! Zeptej se mě na cokoliv ohledně obce Radim.", "bot");
addAiNoteOnce();
</script>

</body>
</html>
