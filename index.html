<!doctype html>
<html lang="cs">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Asistent obce Radim</title>

<style>
:root{
  --bg:#f4f6fb;
  --card:#ffffff;
  --text:#0f172a;
  --muted:#475569;
  --border:#e5e7eb;
  --brand:#1e3a8a;
  --brand-2:#1d4ed8;
  --me:#dbeafe;
  --shadow:0 18px 50px rgba(2,6,23,.16);
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:transparent;
}

/* === CHAT WIDGET === */
.chat-widget{
  position:fixed;
  right:24px;
  bottom:24px;
  width:380px;
  height:600px;
  background:var(--card);
  border:1px solid var(--border);
  border-radius:18px;
  box-shadow:var(--shadow);
  display:none;
  flex-direction:column;
  overflow:hidden;
  z-index:9999;
}

/* HLAVIƒåKA */
.chat-header{
  padding:12px 14px;
  background:linear-gradient(135deg,var(--brand),#15306f);
  color:#fff;
  cursor:pointer;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.header-left{display:flex;gap:10px;align-items:center}
.brandmark{
  width:34px;height:34px;border-radius:10px;
  background:rgba(255,255,255,.15);
  display:flex;align-items:center;justify-content:center;
  font-size:18px;
}
.header-title{font-weight:700;font-size:15px}
.header-sub{font-size:11px;opacity:.85}

.header-right{display:flex;align-items:center;gap:10px}
.chip{
  font-size:11px;
  padding:4px 8px;
  border-radius:999px;
  background:rgba(255,255,255,.15);
}
.toggle{font-size:18px}

/* CHAT */
.chat{
  flex:1;
  padding:14px;
  background:var(--bg);
  overflow-y:auto;
  display:flex;
  flex-direction:column;
  gap:10px;
}

/* ZPR√ÅVY */
.msg{
  max-width:86%;
  padding:10px 12px;
  border-radius:14px;
  font-size:14px;
  line-height:1.45;
  white-space:pre-wrap;
}
.me{
  align-self:flex-end;
  background:var(--me);
  border-bottom-right-radius:6px;
}
.bot{
  align-self:flex-start;
  background:#fff;
  border:1px solid var(--border);
  border-bottom-left-radius:6px;
}
.msg a{color:var(--brand-2);word-break:break-word}

/* INPUT */
.row{
  display:flex;
  gap:8px;
  padding:10px;
  border-top:1px solid var(--border);
}
input{
  flex:1;
  padding:10px 12px;
  border-radius:12px;
  border:1px solid var(--border);
  font-size:14px;
}
button.send{
  width:44px;
  border:0;
  border-radius:12px;
  background:var(--brand);
  color:#fff;
  font-weight:700;
  cursor:pointer;
}

/* === FLOATING BUBBLE === */
.radim-fab{
  position:fixed;
  right:24px;
  bottom:24px;
  width:58px;
  height:58px;
  border-radius:999px;
  border:0;
  cursor:pointer;
  background:linear-gradient(135deg,var(--brand),#15306f);
  color:#fff;
  box-shadow:var(--shadow);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:10000;
}
.radim-fab span{font-size:20px}

/* === N√ÅPOVƒöDA U BUBLINY === */
.radim-hint{
  position:fixed;
  right:96px;
  bottom:36px;
  display:flex;
  align-items:center;
  gap:10px;
  z-index:10001;
  animation:hintFloat 3s ease-in-out infinite;
}
.radim-hint-text{
  background:#ffffff;
  border:1px solid var(--border);
  border-radius:14px;
  padding:10px 14px;
  font-size:13px;
  line-height:1.3;
  box-shadow:var(--shadow);
  color:var(--text);
  white-space:nowrap;
}
.radim-hint-arrow{
  font-size:22px;
  color:var(--brand);
  animation:arrowPulse 1.4s ease-in-out infinite;
}

@keyframes hintFloat{
  0%{transform:translateY(0)}
  50%{transform:translateY(-6px)}
  100%{transform:translateY(0)}
}
@keyframes arrowPulse{
  0%{transform:translateX(0)}
  50%{transform:translateX(6px)}
  100%{transform:translateX(0)}
}

/* === LOADING + FEEDBACK (NOV√â) === */
.loading-bar{
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px 12px;
  margin:0 14px 10px 14px;
  border-radius:12px;
  background:rgba(0,0,0,0.05);
  font-size:13px;
  color:var(--muted);
}
.loading-bar .dot{
  width:10px;height:10px;border-radius:50%;
  background:currentColor;
  animation:pulse 1s infinite;
}
@keyframes pulse{
  0%,100%{opacity:.25; transform:scale(.9)}
  50%{opacity:1; transform:scale(1.1)}
}

.feedback{
  margin:0 14px 10px 14px;
  padding:12px;
  border-radius:14px;
  background:rgba(0,0,0,0.04);
  border:1px solid var(--border);
  font-size:13px;
  color:var(--text);
}
.feedback-q{ margin-bottom:10px; font-weight:600; }
.feedback-actions{ display:flex; gap:8px; }
.feedback-actions button{
  padding:8px 10px;
  border-radius:10px;
  border:1px solid var(--border);
  background:#fff;
  cursor:pointer;
  font-weight:600;
}
.feedback-actions button:hover{
  border-color:#cbd5e1;
}

/* MOBILE */
@media(max-width:480px){
  .chat-widget{right:12px;left:12px;bottom:12px;width:auto;height:80vh}
  .radim-fab{right:12px;bottom:12px}
  .radim-hint{display:none}
}
</style>
</head>

<body>

<!-- CHAT -->
<div id="widget" class="chat-widget">
  <div class="chat-header" onclick="closeChat()">
    <div class="header-left">
      <div class="brandmark">üèõÔ∏è</div>
      <div>
        <div class="header-title">Asistent obce Radim</div>
        <div class="header-sub">Ofici√°ln√≠ informace</div>
      </div>
    </div>
    <div class="header-right">
      <div class="chip">Online</div>
      <span class="toggle">‚åÑ</span>
    </div>
  </div>

  <div id="chat" class="chat"></div>

  <!-- NOV√â: loading + feedback -->
  <div id="loadingBar" class="loading-bar" hidden>
    <span class="dot"></span>
    <span>Generuje se odpovƒõƒè‚Ä¶</span>
  </div>

  <div id="feedbackBox" class="feedback" hidden>
    <div class="feedback-q">Na≈°li jste odpovƒõƒè na ot√°zku?</div>
    <div class="feedback-actions">
      <button type="button" id="feedbackYes">Ano</button>
      <button type="button" id="feedbackNo">Ne</button>
    </div>
  </div>

  <div class="row">
    <input id="q" type="text" placeholder="Napi≈°te dotaz‚Ä¶" />
    <button id="send" class="send">‚Ä∫</button>
  </div>
</div>

<!-- BUBBLINA -->
<button id="fab" class="radim-fab" onclick="openChat()">
  <span>üèõÔ∏è</span>
</button>

<!-- N√ÅPOVƒöDA -->
<div id="radim-hint" class="radim-hint">
  <div class="radim-hint-text">
    Chcete se na nƒõco zeptat?<br>
    <strong>Kliknƒõte na bublinu</strong>
  </div>
  <div class="radim-hint-arrow">‚ûú</div>
</div>

<script>
const chatEl=document.getElementById("chat");
const input=document.getElementById("q");
const send=document.getElementById("send");
const widget=document.getElementById("widget");
const fab=document.getElementById("fab");
const hint=document.getElementById("radim-hint");

// NOV√â prvky
const loadingBar=document.getElementById("loadingBar");
const feedbackBox=document.getElementById("feedbackBox");
const feedbackYes=document.getElementById("feedbackYes");
const feedbackNo=document.getElementById("feedbackNo");

// nastaven√≠ kontaktu (DOPL≈á)
const OFFICE_PHONE = "DOPL≈á_TEL_NA_√ö≈òAD";     // nap≈ô. "+420 123 456 789"
const OFFICE_EMAIL = "DOPL≈á_EMAIL_√ö≈òADU";     // voliteln√©, klidnƒõ nechej pr√°zdn√©

let userQuestionCount = 0;       // kolik dotaz≈Ø u≈æivatel poslal
let awaitingFeedback = false;    // aby se feedback nespustil v√≠ckr√°t najednou

function openChat(){
  widget.style.display="flex";
  fab.style.display="none";
  hint.style.display="none";
  setTimeout(()=>input.focus(),100);
}
function closeChat(){
  widget.style.display="none";
  fab.style.display="flex";
  hint.style.display="flex";
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
}
function linkify(t){
  const s=escapeHtml(t);
  return s.replace(/(https?:\/\/[^\s]+)/g,u=>`<a href="${u}" target="_blank">${u}</a>`);
}
function addMessage(who,text,cls){
  const d=document.createElement("div");
  d.className="msg "+cls;
  d.innerHTML=`<strong>${who}:</strong> ${linkify(text.replace(/\d+\:\d+‚Ä†source/g,""))}`;
  chatEl.appendChild(d);
  chatEl.scrollTop=chatEl.scrollHeight;
}

function showLoading(on){
  loadingBar.hidden = !on;
  // kdy≈æ se zapne loading, schov√°me feedback (a≈• se nep≈ôekr√Ωv√°)
  if(on) feedbackBox.hidden = true;
  // dr≈æ√≠me scroll u spodku
  chatEl.scrollTop = chatEl.scrollHeight;
}

function showFeedback(){
  if(userQuestionCount < 2) return;       // a≈æ po 2. dotazu
  if(awaitingFeedback) return;            // u≈æ ƒçek√°me na feedback
  awaitingFeedback = true;
  feedbackBox.hidden = false;
  chatEl.scrollTop = chatEl.scrollHeight;
}

function hideFeedback(){
  feedbackBox.hidden = true;
  awaitingFeedback = false;
}

feedbackYes.onclick = () => {
  hideFeedback();
  addMessage("Radim","Super üôÇ Jsem r√°d, ≈æe jsem pomohl. Kdykoliv se zeptejte znovu.","bot");
};

feedbackNo.onclick = () => {
  hideFeedback();
  let msg = "Mrz√≠ mƒõ to. Zkuste pros√≠m dotaz up≈ôesnit (nap≈ô. m√≠sto, term√≠n, n√°zev dokumentu).\n\n";
  msg += "Je mo≈æn√©, ≈æe tato informace nen√≠ dostupn√° na webu obce. V takov√©m p≈ô√≠padƒõ doporuƒçuji obr√°tit se p≈ô√≠mo na obecn√≠ √∫≈ôad.";
  if(OFFICE_PHONE && !OFFICE_PHONE.includes("DOPL≈á")){
    msg += `\nTelefon: ${OFFICE_PHONE}`;
  }
  if(OFFICE_EMAIL && !OFFICE_EMAIL.includes("DOPL≈á")){
    msg += `\nE-mail: ${OFFICE_EMAIL}`;
  }
  addMessage("Radim",msg,"bot");
};

async function ask(){
  const q=input.value.trim();
  if(!q) return;

  // NOV√â: p≈ôi nov√©m dotazu schovej feedback (pokud vis√≠)
  feedbackBox.hidden = true;

  addMessage("Vy",q,"me");
  input.value="";
  send.disabled=true;
  userQuestionCount++;

  // NOV√â: uka≈æ loading li≈°tu
  showLoading(true);

  try{
    const r=await fetch("/.netlify/functions/search",{
      method:"POST",
      headers:{ "content-type":"application/json" },
      body:JSON.stringify({ message:q })
    });
    const j=await r.json();
    addMessage("Radim",j.answer||"Bez odpovƒõdi","bot");

    // NOV√â: po odpovƒõdi (od 2. dotazu) uka≈æ feedback li≈°tu
    showFeedback();

  }catch(e){
    addMessage("Radim","Chyba spojen√≠.","bot");
  }finally{
    // NOV√â: schovej loading
    showLoading(false);
    send.disabled=false;
  }
}

send.onclick=ask;
input.addEventListener("keydown",e=>e.key==="Enter"&&ask());

// INIT
addMessage("Radim","Ahoj! Zeptej se mƒõ na cokoliv ohlednƒõ obce Radim.","bot");
</script>

</body>
</html>
