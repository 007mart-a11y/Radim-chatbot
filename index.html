<!doctype html>
<html lang="cs">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Asistent obce Radim</title>

<style>
:root{
  --bg:#f4f6fb;
  --card:#ffffff;
  --text:#0f172a;
  --muted:#475569;
  --border:#e5e7eb;
  --brand:#1e3a8a;
  --brand-2:#1d4ed8;
  --me:#dbeafe;
  --shadow:0 18px 50px rgba(2,6,23,.16);
}

*{box-sizing:border-box}
body{
  body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;

  /* fallback pozad√≠ ‚Äì kdy≈æ se otev≈ôe samostatnƒõ */
  background:
    linear-gradient(
      rgba(255,255,255,0.55),
      rgba(255,255,255,0.55)
    ),
    url("/skins/radim/bg.jpg");

  background-size: cover;
  background-position: center;
  background-attachment: fixed;
}

/* aby hidden opravdu schoval prvky */
[hidden]{ display:none !important; }

/* === CHAT WIDGET === */
.chat-widget{
  position:fixed;
  right:24px;
  bottom:24px;
  width:380px;
  height:600px;
  background:var(--card);
  border:1px solid var(--border);
  border-radius:18px;
  box-shadow:var(--shadow);
  display:none;
  flex-direction:column;
  overflow:hidden;
  z-index:9999;
}

/* HLAVIƒåKA */
.chat-header{
  padding:12px 14px;
  background:linear-gradient(135deg,var(--brand),#15306f);
  color:#fff;
  cursor:pointer;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.header-left{display:flex;gap:10px;align-items:center}
.brandmark{
  width:34px;height:34px;border-radius:10px;
  background:rgba(255,255,255,.15);
  display:flex;align-items:center;justify-content:center;
  overflow:hidden;
}
.brandmark img{ width:100%; height:100%; object-fit:contain; padding:4px; }

.header-title{font-weight:700;font-size:15px}
.header-sub{font-size:11px;opacity:.85}

.header-right{display:flex;align-items:center;gap:10px}
.chip{
  font-size:11px;
  padding:4px 8px;
  border-radius:999px;
  background:rgba(255,255,255,.15);
}
.toggle{font-size:18px}

/* CHAT */
.chat{
  flex:1;
  padding:14px;
  background:var(--bg);
  overflow-y:auto;
  display:flex;
  flex-direction:column;
  gap:10px;
}

/* ZPR√ÅVY */
.msg{
  max-width:86%;
  padding:10px 12px;
  border-radius:14px;
  font-size:14px;
  line-height:1.45;
  white-space:pre-wrap;
}
.me{
  align-self:flex-end;
  background:var(--me);
  border-bottom-right-radius:6px;
}
.bot{
  align-self:flex-start;
  background:#fff;
  border:1px solid var(--border);
  border-bottom-left-radius:6px;
}
.msg a{color:var(--brand-2);word-break:break-word}

/* === LOADING + FEEDBACK === */
.loading-bar{
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px 12px;
  margin:0 14px 10px 14px;
  border-radius:12px;
  background:rgba(0,0,0,0.05);
  font-size:13px;
  color:var(--muted);
}
.loading-bar .dot{
  width:10px;height:10px;border-radius:50%;
  background:currentColor;
  animation:pulse 1s infinite;
}
@keyframes pulse{
  0%,100%{opacity:.25; transform:scale(.9)}
  50%{opacity:1; transform:scale(1.1)}
}

.feedback{
  margin:0 14px 10px 14px;
  padding:12px;
  border-radius:14px;
  background:rgba(0,0,0,0.04);
  border:1px solid var(--border);
  font-size:13px;
  color:var(--text);
}
.feedback-q{ margin-bottom:10px; font-weight:600; }
.feedback-actions{ display:flex; gap:8px; }
.feedback-actions button{
  padding:8px 10px;
  border-radius:10px;
  border:1px solid var(--border);
  background:#fff;
  cursor:pointer;
  font-weight:600;
}
.feedback-actions button:hover{ border-color:#cbd5e1; }

/* === INPUT (zv√Ωraznƒõno) === */
.row{
  display:flex;
  gap:10px;
  padding:12px;
  border-top:1px solid var(--border);
  background:linear-gradient(180deg,#fff, #f8fafc);
}

input{
  flex:1;
  padding:12px 14px;
  border-radius:14px;
  border:1px solid #cbd5e1;
  background:#ffffff;
  font-size:14px;
  color:var(--text);
  box-shadow:0 6px 18px rgba(2,6,23,.08);
  outline:none;
}
input::placeholder{ color:#64748b; }
input:focus{
  border-color: rgba(29,78,216,.55);
  box-shadow:0 8px 22px rgba(29,78,216,.18);
}

button.send{
  width:48px;
  height:48px;
  border:0;
  border-radius:14px;
  background:linear-gradient(135deg, var(--brand-2), #0b3ea8);
  color:#fff;
  font-weight:800;
  cursor:pointer;
  box-shadow:0 10px 22px rgba(29,78,216,.22);
}
button.send:hover{ filter:brightness(1.05); }
button.send:active{ transform: translateY(1px); }
button.send:disabled{
  opacity:.55;
  cursor:not-allowed;
  box-shadow:none;
}

/* === SPODN√ç LI≈†TA (m√≠sto bubliny) === */
.radim-bar{
  position:fixed;
  right:18px;
  bottom:18px;
  display:flex;
  align-items:center;
  gap:12px;

  padding:10px 14px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.22);
  cursor:pointer;

  background:linear-gradient(135deg, rgba(30,58,138,.95), rgba(21,48,111,.95));
  color:#fff;
  box-shadow:0 18px 50px rgba(2,6,23,.30);
  z-index:10000;

  transform: translateZ(0);
  animation: barPulse 1.8s ease-in-out infinite;
}
@keyframes barPulse{
  0%,100%{ box-shadow:0 18px 50px rgba(2,6,23,.30); transform:translateY(0); }
  50%{ box-shadow:0 18px 50px rgba(29,78,216,.35); transform:translateY(-2px); }
}

.radim-crest{
  width:34px;
  height:34px;
  border-radius:10px;
  background:rgba(255,255,255,.12);
  border:1px solid rgba(255,255,255,.20);
  padding:4px;
  object-fit:contain;

  animation: crestFloat 1.6s ease-in-out infinite;
}
@keyframes crestFloat{
  0%,100%{ transform:translateY(0) rotate(0deg); }
  50%{ transform:translateY(-2px) rotate(-2deg); }
}

.radim-bar-text{ display:flex; flex-direction:column; line-height:1.1; text-align:left; }
.radim-bar-title{ font-weight:900; font-size:13px; }
.radim-bar-sub{ font-size:11px; opacity:.88; }

.radim-bar-arrow{
  width:26px;
  height:26px;
  border-radius:10px;
  background:rgba(255,255,255,.14);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:18px;
}

/* MOBILE */
@media(max-width:480px){
  .chat-widget{right:12px;left:12px;bottom:12px;width:auto;height:80vh}
  .radim-bar{ right:12px; left:12px; bottom:12px; justify-content:space-between; }
}
</style>
</head>

<body>

<!-- CHAT -->
<div id="widget" class="chat-widget">
  <div class="chat-header" onclick="closeChat()">
    <div class="header-left">
      <div class="brandmark">
        <!-- erb (stejn√Ω jako dole) -->
        <img src="/skins/radim/erb.png" alt="Erb obce Radim">
      </div>
      <div>
        <div class="header-title">Asistent obce Radim</div>
        <div class="header-sub">Ofici√°ln√≠ informace</div>
      </div>
    </div>
    <div class="header-right">
      <div class="chip">Online</div>
      <span class="toggle">‚åÑ</span>
    </div>
  </div>

  <div id="chat" class="chat"></div>

  <!-- Loading li≈°ta -->
  <div id="loadingBar" class="loading-bar" hidden>
    <span class="dot"></span>
    <span>Generuje se odpovƒõƒè‚Ä¶</span>
  </div>

  <!-- Feedback li≈°ta -->
  <div id="feedbackBox" class="feedback" hidden>
    <div class="feedback-q">Na≈°li jste odpovƒõƒè na ot√°zku?</div>
    <div class="feedback-actions">
      <button type="button" id="feedbackYes">Ano</button>
      <button type="button" id="feedbackNo">Ne</button>
    </div>
  </div>

  <div class="row">
    <input id="q" type="text" placeholder="Napi≈°te dotaz‚Ä¶" />
    <button id="send" class="send" aria-label="Odeslat">‚Ä∫</button>
  </div>
</div>

<!-- SPODN√ç LI≈†TA -->
<button id="fab" class="radim-bar" onclick="openChat()">
  <img class="radim-crest" src="/skins/radim/erb.png" alt="Erb obce Radim">
  <div class="radim-bar-text">
    <div class="radim-bar-title">Porad√≠me v√°m</div>
    <div class="radim-bar-sub">Kliknƒõte a napi≈°te dotaz</div>
  </div>
  <div class="radim-bar-arrow">‚Ä∫</div>
</button>

<script>
const chatEl=document.getElementById("chat");
const input=document.getElementById("q");
const send=document.getElementById("send");
const widget=document.getElementById("widget");
const fab=document.getElementById("fab");

const loadingBar=document.getElementById("loadingBar");
const feedbackBox=document.getElementById("feedbackBox");
const feedbackYes=document.getElementById("feedbackYes");
const feedbackNo=document.getElementById("feedbackNo");

// DOPL≈á kontakt na √∫≈ôad
const OFFICE_PHONE = "DOPL≈á_TEL_NA_√ö≈òAD"; // nap≈ô. "+420 123 456 789"
const OFFICE_EMAIL = "";                  // voliteln√©

let userQuestionCount = 0;
let awaitingFeedback = false;

function openChat(){
  widget.style.display="flex";
  fab.style.display="none";
  setTimeout(()=>input.focus(),100);
}
function closeChat(){
  widget.style.display="none";
  fab.style.display="flex";
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
}
function linkify(t){
  const s=escapeHtml(t);
  return s.replace(/(https?:\/\/[^\s]+)/g,u=>`<a href="${u}" target="_blank" rel="noopener noreferrer">${u}</a>`);
}
function addMessage(who,text,cls){
  const d=document.createElement("div");
  d.className="msg "+cls;
  d.innerHTML=`<strong>${who}:</strong> ${linkify(text.replace(/\d+\:\d+‚Ä†source/g,""))}`;
  chatEl.appendChild(d);
  chatEl.scrollTop=chatEl.scrollHeight;
}

function showLoading(on){
  loadingBar.hidden = !on;
  if(on) feedbackBox.hidden = true;
  chatEl.scrollTop = chatEl.scrollHeight;
}

function showFeedback(){
  if(userQuestionCount < 2) return;
  if(awaitingFeedback) return;
  awaitingFeedback = true;
  feedbackBox.hidden = false;
  chatEl.scrollTop = chatEl.scrollHeight;
}

function hideFeedback(){
  feedbackBox.hidden = true;
  awaitingFeedback = false;
}

feedbackYes.onclick = () => {
  hideFeedback();
  addMessage("Radim","Super üôÇ Jsem r√°d, ≈æe jsem pomohl. Kdykoliv se zeptejte znovu.","bot");
};

feedbackNo.onclick = () => {
  hideFeedback();
  let msg = "Mrz√≠ mƒõ to. Zkuste pros√≠m dotaz up≈ôesnit (nap≈ô. m√≠sto, term√≠n, n√°zev dokumentu).\n\n";
  msg += "Je mo≈æn√©, ≈æe tato informace nen√≠ dostupn√° na webu obce. V takov√©m p≈ô√≠padƒõ doporuƒçuji obr√°tit se p≈ô√≠mo na obecn√≠ √∫≈ôad.";
  if(OFFICE_PHONE && !OFFICE_PHONE.includes("DOPL≈á")){
    msg += `\nTelefon: ${OFFICE_PHONE}`;
  }
  if(OFFICE_EMAIL){
    msg += `\nE-mail: ${OFFICE_EMAIL}`;
  }
  addMessage("Radim",msg,"bot");
};

async function ask(){
  const q=input.value.trim();
  if(!q) return;

  feedbackBox.hidden = true;

  addMessage("Vy",q,"me");
  input.value="";
  send.disabled=true;
  userQuestionCount++;

  showLoading(true);

  try{
    const r=await fetch("/.netlify/functions/search",{
      method:"POST",
      headers:{ "content-type":"application/json" },
      body:JSON.stringify({ message:q })
    });
    const j=await r.json();
    addMessage("Radim",j.answer||"Bez odpovƒõdi","bot");
    showFeedback();
  }catch(e){
    addMessage("Radim","Chyba spojen√≠.","bot");
  }finally{
    showLoading(false);
    send.disabled=false;
    input.focus();
  }
}

send.onclick=ask;
input.addEventListener("keydown",e=>e.key==="Enter"&&ask());

// INIT ‚Äì disclaimer + uv√≠t√°n√≠
addMessage(
  "Radim",
  "Upozornƒõn√≠:\nOdpovƒõdi tohoto asistenta jsou generov√°ny umƒõlou inteligenc√≠ na z√°kladƒõ dostupn√Ωch informac√≠.\nPr√°vnƒõ z√°vazn√© a ofici√°ln√≠ informace si v≈ædy ovƒõ≈ôte na ofici√°ln√≠m webu obce Radim nebo p≈ô√≠mo na obecn√≠m √∫≈ôadƒõ.",
  "bot"
);
addMessage("Radim","Ahoj! Zeptej se mƒõ na cokoliv ohlednƒõ obce Radim.","bot");
</script>

</body>
</html>
