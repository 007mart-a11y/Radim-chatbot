!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <title>Obec Radim – Chatbot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; background:#0f172a; color:#e5e7eb; margin:0; padding:20px }
    #chat { max-width:700px; margin:0 auto 20px }
    .user { background:#2563eb; color:#fff; padding:10px; border-radius:10px; margin:6px 0; text-align:right }
    .bot { background:#1e293b; padding:10px; border-radius:10px; margin:6px 0 }
    .error { background:#7f1d1d }
    #controls { max-width:700px; margin:0 auto; display:flex; gap:10px }
    input { flex:1; padding:10px; border-radius:6px; border:none }
    button { padding:10px 16px; border-radius:6px; border:none; background:#22c55e; cursor:pointer }
  </style>
</head>
<body>

<h2 style="text-align:center">Virtuální asistent obce Radim</h2>

<div id="chat"></div>

<div id="controls">
  <input id="msg" type="text" placeholder="Napište dotaz (např. úřední hodiny)…" />
  <button onclick="sendMessage()">Odeslat</button>
</div>

<script>
  const STORAGE_KEY = "radim_chat_history_v1";
  let history = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");

  function saveHistory() {
    history = history.slice(-20); // max 10 kol
    localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
  }

  function addBubble(text, who) {
    const chat = document.getElementById("chat");
    const div = document.createElement("div");
    div.className = who === "user" ? "user" : "bot";
    div.textContent = text;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  }

  async function sendMessage() {
    const input = document.getElementById("msg");
    const message = input.value.trim();
    if (!message) return;

    addBubble(message, "user");
    input.value = "";

    try {
      const res = await fetch("/.netlify/functions/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message, history })
      });

      const data = await res.json();
      if (!res.ok) throw new Error(data?.error || "Chyba serveru");

      addBubble(data.reply, "bot");

      history.push({ role: "user", content: message });
      history.push({ role: "assistant", content: data.reply });
      saveHistory();

    } catch (err) {
      addBubble("Chyba: " + err.message, "bot");
    }
  }
</script>

</body>
</html>